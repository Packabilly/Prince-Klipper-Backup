[gcode_macro QUAD_GANTRY_LEVEL]
gcode:
    # Initial horizontal_move_z value
    SET_HORIZONTAL_MOVE_Z Z=5.0

    # Define the maximum number of retries
    SET_GCODE_VARIABLE MAX_RETRIES=3

    # Perform bed leveling with retries
    {% set retries = 0 %}
    {% set horizontal_move_z = 5.0 %}
    {% retries < MAX_RETRIES %}
        G28 ; Home all axes
        G29 ; Perform bed probing

        # Call custom macro for additional leveling action
        CUSTOM_LEVELING_ACTION

        # Perform finalization steps for quad gantry leveling
        G29_SAVE ; Save leveling results

        # Check if leveling was successful
        {% if not printer.bed_level.valid %}
            # Increase retry count
            {% set retries = retries + 1 %}
            # Decrease horizontal_move_z by 80% with a minimum of 2
            {% set horizontal_move_z = horizontal_move_z * 0.2 %}
            {% if horizontal_move_z < 2 %}
                {% set horizontal_move_z = 2 %}
            {% endif %}
            # Set new horizontal_move_z value
            SET_HORIZONTAL_MOVE_Z Z={{ horizontal_move_z }}
        {% else %}
            # Exit the loop if leveling was successful
            {% break %}
        {% endif %}
    {% endwhile %}
